From 5d8fd4faebbbe50628e2e35e98a0acdd513e9658 Mon Sep 17 00:00:00 2001
From: Jacob Godserv <jacobgodserv@gmail.com>
Date: Tue, 8 Jun 2010 01:18:08 -0400
Subject: [PATCH 40/52] Added pre-ebuild to ebuild.sh; about to test

---
 bin/ebuild.sh                        |   17 +++++++++++++++++
 pym/portage/hooks.py                 |    2 ++
 pym/portage/package/ebuild/config.py |    5 +++++
 3 files changed, 24 insertions(+), 0 deletions(-)

diff --git a/bin/ebuild.sh b/bin/ebuild.sh
index 60c8f5e..164da83 100755
--- a/bin/ebuild.sh
+++ b/bin/ebuild.sh
@@ -1756,6 +1756,23 @@ preprocess_ebuild_env() {
 	return ${retval}
 }
 
+# Process pre-ebuild hook
+oldwd="$(pwd)"
+hooks_tmpdir="${PORTAGE_TMPDIR}/hooks"
+cd "${HOOKS_PATH}/pre-ebuild.d"
+exit_code="$?"
+if [[ "${exit_code}" != "0" ]]; then
+	# mimicks behavior in hooks.py
+	debug-print "This hook path could not be found; ignored: ${HOOKS_PATH}/pre-ebuild.d"
+fi
+source "${HOOKS_BIN_PATH}" --action "${EBUILD_PHASE}" --target "${$EBUILD}"
+rm -rf "${hooks_tmpdir}"
+exit_code="$?"
+if [[ "${exit_code}" != "0" ]]; then
+	# mimicks behavior in hooks.py
+	die "Hook directory ${HOOKS_PATH}/pre-ebuild.d failed with exit code ${exit_code}"
+fi
+
 # === === === === === === === === === === === === === === === === === ===
 # === === === === === functions end, main part begins === === === === ===
 # === === === === === functions end, main part begins === === === === ===
diff --git a/pym/portage/hooks.py b/pym/portage/hooks.py
index d0db5e1..2c42da6 100644
--- a/pym/portage/hooks.py
+++ b/pym/portage/hooks.py
@@ -32,6 +32,7 @@ class HookDirectory(object):
 		
 		if not os.path.exists(path):
 			if self.myopts and "--debug" in self.myopts:
+				# behavior mimicked ebuild.sh
 				self.output.ewarn('This hook path could not be found; ignored: ' + path)
 			return
 		
@@ -53,6 +54,7 @@ class HookDirectory(object):
 					self.output.einfo('Executing hooks directory "' + self.path + '"...')
 				code = spawn(mycommand=command, env=self.settings.environ())
 				if code: # if failure
+					# behavior mimicked ebuild.sh
 					raise PortageException('!!! Hook directory %s failed with exit code %s' % (self.path, code))
 					
 				if os.path.exists(tmpdir+'/settings/'):
diff --git a/pym/portage/package/ebuild/config.py b/pym/portage/package/ebuild/config.py
index 908b6b6..49232dd 100644
--- a/pym/portage/package/ebuild/config.py
+++ b/pym/portage/package/ebuild/config.py
@@ -170,6 +170,7 @@ class config(object):
 		"EBUILD_PHASE", "ECLASSDIR", "ECLASS_DEPTH", "ED",
 		"EMERGE_FROM", "EPREFIX", "EROOT",
 		"FEATURES", "FILESDIR", "HOME", "NOCOLOR", "PATH",
+		"HOOKS_PATH", "HOOKS_SH_BINARY",
 		"PKGDIR",
 		"PKGUSE", "PKG_LOGDIR", "PKG_TMPDIR",
 		"PORTAGE_ACTUAL_DISTDIR", "PORTAGE_ARCHLIST",
@@ -758,6 +759,8 @@ class config(object):
 
 			self["PORTAGE_CONFIGROOT"] = config_root
 			self.backup_changes("PORTAGE_CONFIGROOT")
+			self["HOOKS_PATH"] = HOOKS_PATH
+			self.backup_changes("HOOKS_PATH")
 			self["ROOT"] = target_root
 			self.backup_changes("ROOT")
 
@@ -982,6 +985,8 @@ class config(object):
 
 			self["PORTAGE_BIN_PATH"] = PORTAGE_BIN_PATH
 			self.backup_changes("PORTAGE_BIN_PATH")
+			self["HOOKS_BIN_PATH"] = HOOKS_BIN_PATH
+			self.backup_changes("HOOKS_BIN_PATH")
 			self["PORTAGE_PYM_PATH"] = PORTAGE_PYM_PATH
 			self.backup_changes("PORTAGE_PYM_PATH")
 
-- 
1.6.4.4

