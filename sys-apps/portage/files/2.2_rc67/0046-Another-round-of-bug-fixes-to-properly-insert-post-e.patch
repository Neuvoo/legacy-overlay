From e44547570a9d43d223a3427f3b75cfec7dade4b5 Mon Sep 17 00:00:00 2001
From: Jacob Godserv <jacobgodserv@gmail.com>
Date: Tue, 8 Jun 2010 03:46:13 -0400
Subject: [PATCH 46/52] Another round of bug fixes to properly insert post-ebuild hooks

---
 bin/ebuild.sh |    2 ++
 bin/hooks.sh  |   20 ++++++++++++++++----
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/bin/ebuild.sh b/bin/ebuild.sh
index 9347953..deb625b 100755
--- a/bin/ebuild.sh
+++ b/bin/ebuild.sh
@@ -661,6 +661,8 @@ _eapi4_src_install() {
 
 ebuild_phase() {
 	declare -F "$1" >/dev/null && qa_call $1
+	# Process post-ebuild hooks for the actual phase (and not internal pre/post phase hooks)
+	[[ "$(expr match $1 '^pre_\|^post_')" == "0" ]] && source "${HOOKS_SH_BINARY}" --do-post-ebuild
 }
 
 ebuild_phase_with_hooks() {
diff --git a/bin/hooks.sh b/bin/hooks.sh
index 1a672a9..ce62a7a 100755
--- a/bin/hooks.sh
+++ b/bin/hooks.sh
@@ -12,21 +12,33 @@
 
 # This code is put here so it's easier to do one-liners elsewhere.
 if [[ "$1" == "--do-pre-ebuild" || "$1" == "--do-post-ebuild" ]]; then
+	if [[ "${EBUILD_PHASE}" == "" ]]; then
+		# probably die_hooks or something evil
+		return
+	fi
+	
+	if ! type hasq &> /dev/null; then
+		source "${PORTAGE_BIN_PATH}/isolated-functions.sh" &> /dev/null
+	fi
 	if hasq hooks $FEATURES ; then
 		oldwd="$(pwd)"
-		hooks_tmpdir="${T}/hooks"
 		if [[ "$1" == "--do-pre-ebuild" ]]; then
+			hooks_tmpdir="${T}/hooks-pre-${EBUILD_PHASE}"
 			hooks_dir="${PORTAGE_CONFIGROOT}/${HOOKS_PATH}/pre-ebuild.d"
 		else
+			hooks_tmpdir="${T}/hooks-post-${EBUILD_PHASE}"
 			hooks_dir="${PORTAGE_CONFIGROOT}/${HOOKS_PATH}/post-ebuild.d"
 		fi
-		( [ ! -d "${hooks_dir}" ] && exit 1 ) && cd "${hooks_dir}"
+		[ -d "${hooks_dir}" ] && cd "${hooks_dir}"
 		exit_code="$?"
 		if [[ "${exit_code}" != "0" ]]; then
 			# mimicks behavior in hooks.py
-			debug-print "This hook path could not be found; ignored: ${hooks_dir}"
+			# TODO: --verbose detection?
+			:
+			#debug-print "This hook path could not be found; ignored: ${hooks_dir}"
 		else
-			mkdir "${hooks_tmpdir}" && source "${HOOKS_SH_BINARY}" --action "${EBUILD_PHASE}" --target "${EBUILD}"
+			mkdir "${hooks_tmpdir}" || die "Could not create temporary hooks output directory: ${hooks_tmpdir}"
+			source "${HOOKS_SH_BINARY}" --action "${EBUILD_PHASE}" --target "${EBUILD}"
 			exit_code="$?"
 			if [[ "${exit_code}" != "0" ]]; then
 				# mimicks behavior in hooks.py
-- 
1.6.4.4

