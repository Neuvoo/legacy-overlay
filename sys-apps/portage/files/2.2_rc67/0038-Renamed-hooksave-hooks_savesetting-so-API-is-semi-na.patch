From 2172efd11c921fbaf467a5e1b3a7a8b02232a961 Mon Sep 17 00:00:00 2001
From: Jacob Godserv <jacobgodserv@gmail.com>
Date: Mon, 7 Jun 2010 23:20:05 -0400
Subject: [PATCH 38/52] Renamed hooksave -> hooks_savesetting, so API is semi-namespaced and clear. Also added a new function hooks_killportage.

---
 bin/hooks.sh                                  |   23 +++++++++++++++++++++--
 pym/portage/tests/hooks/test_HookDirectory.py |    2 +-
 2 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/bin/hooks.sh b/bin/hooks.sh
index 3c7bd63..cccd0c2 100755
--- a/bin/hooks.sh
+++ b/bin/hooks.sh
@@ -10,7 +10,7 @@
 # hooks within a prepared environment, as well as acting as an API interface
 # between hooks and portage.
 
-# @FUNCTION: hooks_savetosettings
+# @FUNCTION: hooks_savesetting
 # @DESCRIPTION:
 # This function saves a variable in the environment into portage's internal
 # settings variable, which is not only used by portage but also used as the
@@ -22,7 +22,7 @@
 # 
 # NOTE: to configure only the environment of the currently running ebuild, while
 # running inside an ebuild hook, simply set the variable inside the hook.
-function hooksave () {
+function hooks_savesetting () {
 	local unsecure_varname="$1"
 	local varname="$(basename ${unsecure_varname})"
 	
@@ -35,6 +35,25 @@ function hooksave () {
 	declare -p "${varname}" | sed '1s|^[^=]*=['"'"'"]||; $s|['"'"'"]$||' > "${hooks_tmpdir}/${varname}" || return $?
 }
 
+# @FUNCTION: hooks_killportage
+# @DESCRIPTION:
+# This is a convenience function, which allows a hook to stop portage
+# immediately. This will cause portage to exit cleanly, but with an error code.
+# 
+# Takes one optional argument, which is the signal, passed to kill via the -s
+# argument.
+function hooks_killportage () {
+	local signal="$1"
+	
+	local args=( )
+	if [[ "${signal}" != "" ]]; then
+		args+=( -s "${signal}" )
+	fi
+	args+=( "${PPID}" )
+	
+	kill "${args[@]}"
+}
+
 # Local variables listed here.
 # Using the local keyword makes no difference since this script is being sourced
 # so we'll have to unset them manually later. Be sure to keep the local_vars
diff --git a/pym/portage/tests/hooks/test_HookDirectory.py b/pym/portage/tests/hooks/test_HookDirectory.py
index 3527e67..e8b57bc 100644
--- a/pym/portage/tests/hooks/test_HookDirectory.py
+++ b/pym/portage/tests/hooks/test_HookDirectory.py
@@ -45,7 +45,7 @@ class HookDirectoryTestCase(TestCase):
 		f = open(hooks_dir+'/testhook', 'w')
 		f.write('#!/bin/bash\n')
 		f.write('test="this is a test"\n')
-		f.write('echo hi > '+tmp_dir+'/output && hooksave test && exit 0\n')
+		f.write('echo hi > '+tmp_dir+'/output && hooks_savesetting test && exit 0\n')
 		f.close()
 		
 		return tmp_dir
-- 
1.6.4.4

